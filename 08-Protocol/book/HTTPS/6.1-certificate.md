数字证书
===

数字证书便集合了多种密码学算法，从而有更高的安全强度：

- 消息摘要算法用于对数字证书本身做摘要处理，确保数字证书完整性。
- 非对称算法用于对数据进行加密/解密操作，确保数据的机密性。
- 数字签名算法用于对数据进行签名/验证操作，确保数据的来源和抗否认性。

目前数字证书中最常用的非对称加密算法是RSA算法，与之配套使用的签名算法是SHA1withRSA算法，最为常用的消息摘要算法是SHA1算法。

数字证书有多重文件编码格式，所有证书都符合公钥基础设施（PKI）制定的ITU-T X509国际标准：

- CER（Canonical Encoding Rules，规范编码格式），BER的变种，使用变长模式。
- DER（Distinguished Encoding Rule，卓越编码格式），BER的变种，使用定长模式。
- PKCS（Public-Key Cryptography Standards，公钥加密标准），常用标准有PKS#7，PKS#10，PKS#12。

数字证书文件的存储格式通常为Base64。实际应用中，很多数字证书都属于自签名证书，即证书申请者为自己的证书签名。这类证书通常应用于软件厂商内部发放的产品中，或约定使用该证书的数据交互双方。数字证书完全充当加密算法的载体，为必要数据做加密/解密和签名/验证等操作。自签名的证书虽然可以使用，但未经CA（Certificate Authority，数字证书颁发认证机构）认证，无法律效力。

### 证书签发

![CER](img/6.1-cer.png)

1. 数字证书需求方产生自己的密钥对。
2. 数字证书需求方将算法，公钥，身份信息传送给认证机构。
3. 认证机构核实用户身份。
4. 认证机构颁发数字证书。

### 加密交互

![REQ](img/6.1-req.png)

1. 客户端使用公钥对数据加密。
2. 客户端向服务端发送加密数据。
3. 服务端使用私钥解密数据。

![RSP](img/6.1-rsp.png)

1. 服务端使用私钥对数据签名(先对响应摘要，再用私钥加密，即生成数字签名)。
2. 服务端使用私钥对数据加密。
3. 服务端向客户端发送加密数据和数字签名，数字证书。
4. 客户端使用公钥对数据（加密数据和数字签名）解密。
5. 客户端使用公钥和解密的数据验证签名。客户端对响应进行Hash，得到摘要后与解密后的数字签名做对比
如果一致，说明数据没有被篡改

### 数字签名与数字证书

1）数字签名

- 定义：服务端使用Hash算法，对响应生成摘要（digest），然后使用私钥，对摘要加密，生成数字签名（signature）。
- 作用：客户端使用公钥解密数字签名和响应数据，得到服务端生成的摘要和响应数据。客户端再对响应数据进行哈希，将得到的结果，与上一步得到的摘要对比。如果一致，证明数据没有被篡改过。

2）数字证书

- 定义：证书中心（certificate authority，CA）用自己的私钥，对服务器公钥和相关信息一起加密，生成数字证书（Digital Certificate）。
- 作用：为防止恶意服务器，需要证书中心为公钥做认证。
服务端拿到数字证书后，发送给客户端时，只要在签名的同时，再附上数字证书即可。
客户端收到响应后，用CA的公钥解开数字证书，就可以拿到服务器真实公钥。进而验证数据完整性，加解密交互。

### 证书管理

要获取证书，需要使用数字证书管理工具构建CSR（Certificate Signing Request，数字证书签发申请），交由CA（Certificate Authority，数字证书颁发认证机构）签发，形成最终的数字证书。

常用数字证书管理工具：

- KeyTool，Java中的数字证书管理工具，KeyTool与本地密钥库相关联，将私钥存入密钥库，公钥则以数字证书输出。
- OpenSSL，开源数字证书管理工具，功能远胜于KeyTool，可用于根证书，服务器证书和客户端证书的管理。
