TCP 三次握手与四次挥手
===


[tcp](img/tcp.jpg)

### 三次握手

##### 1. 第一次握手
客户端发送连接请求报文段，将 SYN 置为 1，seq 置为 x，进入 SYN_SEND 状态，等待服务器确认.

##### 2. 第二次握手
服务器对收到的 SYN 报文段进行确认，将 SYN 置为 1，seq 为 y，ACK 为 seq + 1；
将上述所有信息放入一个报文段发送给客户端，并进入 SYN_RECV 状态；

##### 3. 第三次握手
客户端收到服务器的 SYN + ACK 报文段，进入 ESTABLISHED 状态。将 ACK 置为 y + 1，发送给服务端，服务器端收到也进入 ESTABLISHED 状态，从而完成 TCP 三次握手。

### 为何需要三次握手

为了防止已失效的连接请求报文段突然又传送到了服务端，因而产生错误，防止服务器一直等待浪费资源。举例说明“已失效的连接请求报文段”发生场景：

1. client 发出的第一个连接请求报文段并没有丢失，而是在某个网络结点长时间滞留，直到连接释放以后才到达 server,
本来这是一个早已失效的报文段。但 server 误认为是 client 再次发出的新的连接请求,于是就向 client 发出确认报文段，同意建立连接。
2. 如果不采用“三次握手”，只要 server 发出确认，新的连接就会建立。而 client 并没有发出建立连接的请求，因此不会理睬 server 的确认，也不会向 server 发送数据，但 server 却以为新的运输连接已经建立，并一直等待 client 发来数据，耗费 server 资源。
3. 而采用“三次握手”，client 不会对 server 响应进行确认。server 收不到确认，可知 client 并没有要求建立连接，从而防止耗费服务器资源。


### 四次挥手

##### 1. 第一次分手：
主机 1（可以使客户端，也可以是服务器端），设置 seq 和 ACK，向主机 2 发送一个 FIN 报文段；此时主机 1 进入 FIN_WAIT_1 状态；这表示主机 1 不会再发数据给主机 2；

##### 2. 第二次分手
主机 2 收到了主机 1 发送的 FIN 报文段，向主机 1 回一个 ACK 报文段，ACK 为 seq + 1 ；主机 1 进入 FIN_WAIT_2 状态；等待主机 2 告诉主机 1 数据剩余数据传输完毕；

##### 3. 第三次分手
主机 2 向主机 1 发送 FIN 报文段，请求关闭连接，同时主机 2 进入 CLOSE_WAIT 状态；

##### 4. 第四次分手
主机 1 收到主机 2 发送的 FIN 报文段，向主机 2 发送 ACK 报文段，然后主机 1 进入 TIME_WAIT 状态；主机 2 收到主机 1 的 ACK 报文段以后，就关闭连接；此时，主机 1 等待 2MSL 还没有收到回复，表明 Server 端已正常关闭，主机 1 也关闭连接。


### 为何需要四次挥手

TCP 协议是一种面向连接的、可靠的、基于字节流的运输层通信协议。TCP 是全双工模式，这就意味着，当主机 1 发出 FIN 报文段时，只是表示主机 1 已经没有数据要发送给主机 2，但主机 1 可能会收到主机 2 发送的数据；主机 2 同理。


### 附录

1. seq : Sequence Number
2. ACK : Acknowledgment Number
3. 全双工：指可以同时进行信号的双向传输（A→B 且 B→A）。指A→B的同时B→A，是瞬时同步的，如打电话，可听到对方说话的同时，也可以说话。
4. 半双工：指数据可以在一个信号载体的两个方向上传输，但是不能同时传输。通信信道的每一段都可以是发送端，也可以是接收端。但同一时刻里，信息只能有一个传输方向。如潮汐车道。

